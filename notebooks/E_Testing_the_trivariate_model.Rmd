---
title: "E_Testing_the_trivariate_model_on_GTP"
output:
  html_notebook:
    toc: yes
    toc_float: yes
date: "May 5, 2020"
---


```{r}
.libPaths( c( "/opt/R/3.6.2/lib/R/library" , .libPaths() ) )
.libPaths()
```

```{r}
library(tidyverse)
```


## Load data

```{r}
# Ft. Campbell pheno data
t1 <- read_delim("/data/humgen/burook/FC_analysis/table_pred", col_names = TRUE, delim = " ") 


fc_pheno2 <- read_delim("/data/humgen/burook/data_raw/fc/clinical/FC_data_for_PGM.txt", col_names = TRUE, delim = "\t") %>% 
  mutate(ID=as.character(ID)) %>% 
  full_join(t1, by=c("ID"="Sample")) %>% 
  subset(select=c("PTSD_status", "CTQ_total_abuse_score","EDUCATION_LEVEL")) %>% 
  mutate(CA4 = cut(CTQ_total_abuse_score, breaks = c(-Inf,20,30,40,Inf), right=T, labels = F)) %>% 
  mutate(EA4 = cut(EDUCATION_LEVEL, breaks = c(-Inf,2,3,4,Inf), right=T, labels = F)) 


```



```{r}
# GTP pheno data
pcs1 = read.table("/data/humgen/burook/GTP_analysis/gtp_ptsd/ANCESTRY_INFORMATIVE_DIMENSIONS.mds", header = TRUE) 
prs1 = read.table("/data/humgen/burook/GTP_analysis/gtp_ptsd/gtp_ptsd_SCORES_AT_BEST-FIT-PRS.txt", header = TRUE) 
prs1[,2]=scale(prs1[,2],center=T,scale=T); colnames(prs1)=c("IID","prs");
t1 <- read_delim("/data/humgen/burook/GTP_analysis/table_pred", col_names = TRUE, delim = " ")

gtp_pheno2 <- read_delim("/data/humgen/burook/GTP_analysis/GTP_pheno1.txt", col_names = TRUE, delim = "\t") %>% 
#  filter(!is.na(PTSD_status)) %>% 
  full_join(t1, by=c("IID"="Sample")) %>% 
  filter(is.na(SuperPopulation)) %>% 
  full_join(pcs1, by=("IID")) %>% 
  full_join(prs1, by=("IID")) %>% 
  filter(PTSD_diagnosis==0 | PTSD_diagnosis==1) %>% 
  filter(predtree=='AFR') %>% 
  mutate(PTSD_status = factor(PTSD_diagnosis, labels =c("Negative","Positive"))) %>% 
  mutate(CA4 = cut(CTQTOT, breaks = c(-Inf,40,60,80,Inf), right=T,labels = F)) %>%
  mutate(EA4 = cut(education, breaks = c(-Inf,1,3,4,Inf), right=T,labels = F)) %>% 
  mutate(prs_quantiles = cut(prs, breaks = quantile(prs1$prs, probs = seq(0, 1, 1/4)), include.lowest=T)) %>% 
  mutate(prs_quantiles=as.numeric(prs_quantiles)) %>% 
  subset(select=c("PTSD_status","PSStotal", "CTQTOT","education","CA4","EA4","prs","prs_quantiles")) %>% 
  filter(!is.na(prs))

```


```{r}
# AURORA pheno data
# let's load necessary files for performance analysis and plots
aur_pheno1 <- read_delim("/data/humgen/burook/AURORA/aur_pheno1.txt", col_names = TRUE, delim = "\t")
pcs1 = read.table("/data/humgen/burook/AURORA/aur_ptsd_afr/ANCESTRY_INFORMATIVE_DIMENSIONS.mds", header = TRUE)
prs1 = read.table("/data/humgen/burook/AURORA/aur_ptsd_afr/aur_ptsd_SCORES_AT_BEST-FIT-PRS.txt", header = TRUE)
prs1[,2]=scale(prs1[,2],center=T,scale=T); colnames(prs1)=c("IID","prs");
prs1[,2] = -1*prs1[,2]      # the prs sign is inverted, let's correct it
# also let's load the file containing predicted ancestry labels
t1 <- read_delim("/data/humgen/burook/AURORA/table_pred", col_names = TRUE, delim = " ")

aur_pheno2 <- t1 %>% 
  filter(is.na(SuperPopulation)) %>% 
  mutate(IID=Sample) %>% 
  full_join(aur_pheno1, by="IID") %>% 
  full_join(pcs1, by="IID") %>% 
  full_join(prs1, by="IID") %>% 
  filter(!is.na(prs)) %>% 
  filter(predtree=='AFR') %>% 
  mutate(PTSD_status = factor(M3_PCL5, labels =c("Negative","Positive"))) %>% 
  mutate(CA4 = as.numeric(cut(WK2_CTQSF_Total_RS, breaks = c(-Inf,1,4,7,9), right=T))) %>% 
  mutate(EA4 = cut(ED_HighestGrade, breaks = c(-Inf,12,14,16,17), right=T,labels = F)) %>% 
  mutate(prs_quantiles = cut(prs, breaks = quantile(prs1$prs, probs = seq(0, 1, 1/4)), include.lowest=T)) %>% 
  mutate(prs_quantiles=as.numeric(prs_quantiles)) %>% 
  subset(select=c("PTSD_status","M3_PCL5_RS", "WK2_CTQSF_Total_RS","ED_HighestGrade","CA4","EA4","prs","prs_quantiles"))

```


```{r}
load(file = "/data/humgen/burook/ptsd_multimodal_prediction_stage1/model1.RData")


require(pROC)

for (j in (2:4)) {
  if (j==2){         # FC
  }
  if (j==3){         # GTP
    Test1 <- gtp_pheno2 %>% 
      filter(complete.cases(gtp_pheno2[,c("PTSD_status", "prs", "CA4", "EA4")])) %>% 
      subset(select=c("PTSD_status", "prs_quantiles", "CA4", "EA4")) 
    xTest1 <- as.matrix(Test1[,c("prs_quantiles","CA4","EA4")])
    yTest1 <- factor(as_vector(Test1[,c("PTSD_status")]), labels = c("control","case"))
  }
  if (j==4){         # AURORA
    Test1 <- aur_pheno2 %>% 
      filter(complete.cases(aur_pheno2[,c("PTSD_status", "prs", "CA4", "EA4")])) %>% 
      subset(select=c("PTSD_status", "prs_quantiles", "CA4", "EA4")) 
    xTest1 <- as.matrix(Test1[,c("prs_quantiles","CA4","EA4")])
    yTest1 <- factor(as_vector(Test1[,c("PTSD_status")]), labels = c("control","case"))
  }

  
  for (i in (1:4)) {
    ###~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~# logistic regression
    if (i==1){          
      require(caret)
      pred = predict(lr1, newdata=as.data.frame(xTest1), type='prob')
      AUC3[i,j] = (pROC::roc(yTest1, pred[,1],ci=F))$auc
    }
    ###~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~# SVM
    if (i==2){          
      require(kernlab)   
      pred = predict(svm1, newdata=xTest1, type="prob")
      AUC3[i,j] = (pROC::roc(as.factor(yTest1), pred[,1],ci=T))$auc
    }
    ###~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~# boosted tree
    if (i==3){          
      require(gbm)   
      pred = predict(gbm1, newdata=xTest1, type="prob")
      AUC3[i,j] = (pROC::roc(as.factor(yTest1), pred[,1],ci=T))$auc
    }
    ###~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~# Random forest
    if (i==4){          
      require(randomForest)
      pred = predict(rf1, newdata=xTest1, type="prob")
      AUC3[i,j] = (pROC::roc(as.factor(yTest1), pred[,1],ci=T))$auc
    }
  }
}



AUC3

```


